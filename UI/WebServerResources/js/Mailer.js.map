{"version":3,"sources":["Mailer/Mailer.app.js"],"names":["configure","$stateProvider","$urlRouterProvider","state","url","abstract","views","mailboxes","templateUrl","controller","controllerAs","resolve","stateAccounts","mailbox","template","stateAccount","mailbox@mail","stateMailbox","stateVirtualMailbox","message","stateVirtualMailboxOfMessage","stateMessages","stateMessage","stateInbox","onEnter","onEnterMessage","onExit","onExitMessage","otherwise","$q","Account","accounts","$findAll","window","mailAccounts","promises","angular","forEach","account","i","$getMailboxes","push","then","objects","all","$stateParams","_","find","id","accountId","$state","decodeUriFilter","Mailbox","_find","mailboxId","o","path","children","length","selectedFolder","$isLoading","$mailboxes","go","$virtualMode","$filter","reject","resetSelectedMessage","mailboxObject","encodeUriFilter","$messages","messageObject","uid","parseInt","messageId","$reload","$account","selectedMessage","runBlock","$rootScope","$log","$on","event","toState","toParams","fromState","fromParams","error","current","previous","rejection","module","config","run","$inject"],"mappings":"CAGA,WACE,YAUA,SAASA,GAAUC,EAAgBC,GACjCD,EACGE,MAAM,QACLC,IAAK,QACLC,YAAU,EACVC,OACEC,WACEC,YAAa,mBACbC,WAAY,sBACZC,aAAc,QAGlBC,SACEC,cAAeA,KAGlBT,MAAM,gBACLC,IAAK,cACLC,YAAU,EACVC,OACEO,SACEC,SAAU,eAGdH,SACEI,aAAcA,KAGjBZ,MAAM,+BACLC,IAAK,WACLE,OACEU,gBACER,YAAa,wBACbC,WAAY,oBACZC,aAAc,YAGlBC,SACEM,aAAcC,KAGjBf,MAAM,uCACLC,IAAK,yBACLE,OACGa,SACCX,YAAa,sBACbC,WAAY,oBACZC,aAAc,WAGlBC,SACEM,aAAcG,EACdC,cAAeA,EACfC,aAAcA,KAGjBnB,MAAM,sBACLC,IAAK,SACLE,OACEU,gBACER,YAAa,wBACbC,WAAY,oBACZC,aAAc,YAGlBC,SACEM,aAAcM,EACdF,cAAeA,KAGlBlB,MAAM,wBACLC,IAAK,cACLE,OACEU,gBACER,YAAa,wBACbC,WAAY,oBACZC,aAAc,YAGlBC,SACEM,aAAcA,EACdI,cAAeA,KAgBlBlB,MAAM,gCACLC,IAAK,cACLE,OACEa,SACEX,YAAa,sBACbC,WAAY,oBACZC,aAAc,WAGlBc,QAASC,EACTC,OAAQC,EACRhB,SACEW,aAAcA,KA4BpBpB,EAAmB0B,UAAU,iBAO/B,QAAShB,GAAciB,EAAIC,GACzB,GAAIC,GAAWD,EAAQE,SAASC,OAAOC,cACnCC,IAQJ,OANAC,SAAQC,QAAQN,EAAU,SAASO,EAASC,GAC1C,GAAIhC,GAAY+B,EAAQE,eACxBL,GAASM,KAAKlC,EAAUmC,KAAK,SAASC,GACpC,MAAOL,QAGJT,EAAGe,IAAIT,GAOhB,QAASpB,GAAa8B,EAAcjC,GAClC,MAAOkC,GAAEC,KAAKnC,EAAe,SAAS0B,GACpC,MAAOA,GAAQU,IAAMH,EAAaI,YAQtC,QAAShC,GAAaY,EAAIqB,EAAQL,EAAc9B,EAAcoC,EAAiBC,GAC7E,GAAIvC,GAEAwC,EADAC,EAAYH,EAAgBN,EAAaS,UAuB7C,OAnBAD,GAAQ,SAAS9C,GACf,GAAIM,GAAUiC,EAAEC,KAAKxC,EAAW,SAASgD,GACvC,MAAOA,GAAEC,MAAQF,GASnB,OAPKzC,IACHuB,QAAQC,QAAQ9B,EAAW,SAASgD,IAC7B1C,GAAW0C,EAAEE,UAAYF,EAAEE,SAASC,OAAS,IAChD7C,EAAUwC,EAAME,EAAEE,aAIjB5C,GAGLuC,EAAQO,iBACVP,EAAQO,eAAeC,YAAa,GAEtC/C,EAAUwC,EAAMtC,EAAa8C,YAEzBhD,EACKA,EAGAqC,EAAOY,GAAG,sBAOrB,QAASvC,GAAWR,EAAcqC,GAIhC,MAHIA,GAAQO,iBACVP,EAAQO,eAAeC,YAAa,GAE/B7C,EAAa8C,WAAW,GAOjC,QAASxC,GAAc+B,EAASnC,GAC9B,MAAImC,GAAQW,gBAGL9C,EAAa+C,UAgBtB,QAAS9C,GAAoBW,EAAIuB,GAC/B,MAAIA,GAAQW,aACHX,EAAQO,eAER9B,EAAGoC,OAAO,8BAQrB,QAAS7C,GAA6BS,EAAIuB,EAASD,EAAiBN,GAClE,GAAIS,GAAYH,EAAgBN,EAAaS,UAE7C,OAAIF,GAAQW,cACVX,EAAQO,eAAeO,uBAChBpB,EAAEC,KAAKK,EAAQO,eAAeE,WAAY,SAASM,GACxD,MAAOA,GAAcX,MAAQF,KAIxBzB,EAAGoC,OAAO,0CAOrB,QAAS3C,GAAa8B,EAASgB,EAAiBvB,EAAcK,EAAQjC,EAAcI,GAClF,GAAIF,EAMJ,QAJAA,EAAU2B,EAAEC,KAAK9B,EAAaoD,UAAW,SAASC,GAChD,MAAOA,GAAcC,KAAOC,SAAS3B,EAAa4B,cAI3CtD,EAAQuD,cAIfxB,GAAOY,GAAG,wBAA0Bb,UAAWhC,EAAa0D,SAAS3B,GAAIM,UAAWc,EAAgBnD,EAAauC,QAQrH,QAAS/B,GAAeoB,EAAc5B,GACpCA,EAAa2D,gBAAkBJ,SAAS3B,EAAa4B,WAOvD,QAAS9C,GAAcV,GACrBA,EAAa2D,gBAAkB,GAejC,QAASC,GAASC,EAAYC,EAAM7B,GAClC4B,EAAWE,IAAI,oBAAqB,SAASC,EAAOC,EAASC,EAAUC,EAAWC,EAAYC,GAC5FP,EAAKO,MAAMA,GACXpC,EAAOY,GAAG,UAEZgB,EAAWE,IAAI,oBAAqB,SAASC,EAAOM,EAASC,EAAUC,GACrEV,EAAKO,MAAML,EAAOM,EAASC,EAAUC,KArUzCrD,QAAQsD,OAAO,iBAAkB,YAAa,KAAM,oBAAqB,cAAe,kBAAmB,YAAa,uBACrHC,OAAO3F,GACP4F,IAAIf,GAKP7E,EAAU6F,SAAW,iBAAkB,sBAgJvCjF,EAAciF,SAAW,KAAM,WAiB/B9E,EAAa8E,SAAW,eAAgB,iBAUxC5E,EAAa4E,SAAW,KAAM,SAAU,eAAgB,eAAgB,kBAAmB,WAoC3FtE,EAAWsE,SAAW,eAAgB,WAWtCxE,EAAcwE,SAAW,UAAW,gBAoBpC3E,EAAoB2E,SAAW,KAAM,WAYrCzE,EAA6ByE,SAAW,KAAM,UAAW,kBAAmB,gBAiB5EvE,EAAauE,SAAW,UAAW,kBAAmB,eAAgB,SAAU,eAAgB,iBAoBhGpE,EAAeoE,SAAW,eAAgB,gBAQ1ClE,EAAckE,SAAW,gBAgBzBhB,EAASgB,SAAW,aAAc,OAAQ","file":"Mailer.js","sourcesContent":["/* -*- Mode: javascript; indent-tabs-mode: nil; c-basic-offset: 2 -*- */\n/* JavaScript for SOGo.MailerUI module */\n\n(function() {\n  'use strict';\n\n  angular.module('SOGo.MailerUI', ['ui.router', 'ck', 'angularFileUpload', 'SOGo.Common', 'SOGo.ContactsUI', 'ngAnimate', 'SOGo.PreferencesUI'])\n    .config(configure)\n    .run(runBlock);\n\n  /**\n   * @ngInject\n   */\n  configure.$inject = ['$stateProvider', '$urlRouterProvider'];\n  function configure($stateProvider, $urlRouterProvider) {\n    $stateProvider\n      .state('mail', {\n        url: '/Mail',\n        abstract: true,\n        views: {\n          mailboxes: {\n            templateUrl: 'UIxMailMainFrame', // UI/Templates/MailerUI/UIxMailMainFrame.wox\n            controller: 'MailboxesController',\n            controllerAs: 'app'\n          }\n        },\n        resolve: {\n          stateAccounts: stateAccounts\n        }\n      })\n      .state('mail.account', {\n        url: '/:accountId',\n        abstract: true,\n        views: {\n          mailbox: {\n            template: '<ui-view/>'\n          }\n        },\n        resolve: {\n          stateAccount: stateAccount\n        }\n      })\n      .state('mail.account.virtualMailbox', {\n        url: '/virtual',\n        views: {\n          'mailbox@mail': {\n            templateUrl: 'UIxMailFolderTemplate', // UI/Templates/MailerUI/UIxMailFolderTemplate.wox\n            controller: 'MailboxController',\n            controllerAs: 'mailbox'\n          }\n        },\n        resolve: {\n          stateMailbox: stateVirtualMailbox\n        }\n      })\n      .state('mail.account.virtualMailbox.message', {\n        url: '/:mailboxId/:messageId',\n        views: {\n           message: {\n            templateUrl: 'UIxMailViewTemplate', // UI/Templates/MailerUI/UIxMailViewTemplate.wox\n            controller: 'MessageController',\n            controllerAs: 'viewer'\n          }\n        },\n        resolve: {\n          stateMailbox: stateVirtualMailboxOfMessage,\n          stateMessages: stateMessages,\n          stateMessage: stateMessage\n        }\n      })\n      .state('mail.account.inbox', {\n        url: '/inbox',\n        views: {\n          'mailbox@mail': {\n            templateUrl: 'UIxMailFolderTemplate', // UI/Templates/MailerUI/UIxMailFolderTemplate.wox\n            controller: 'MailboxController',\n            controllerAs: 'mailbox'\n          }\n        },\n        resolve: {\n          stateMailbox: stateInbox,\n          stateMessages: stateMessages\n        }\n      })\n      .state('mail.account.mailbox', {\n        url: '/:mailboxId',\n        views: {\n          'mailbox@mail': {\n            templateUrl: 'UIxMailFolderTemplate', // UI/Templates/MailerUI/UIxMailFolderTemplate.wox\n            controller: 'MailboxController',\n            controllerAs: 'mailbox'\n          }\n        },\n        resolve: {\n          stateMailbox: stateMailbox,\n          stateMessages: stateMessages\n        }\n      })\n      // .state('mail.account.mailbox.newMessage', {\n      //   url: '/new',\n      //   views: {\n      //     'mailbox@mail': {\n      //       templateUrl: 'UIxMailEditor', // UI/Templates/MailerUI/UIxMailEditor.wox\n      //       controller: 'MessageEditorController',\n      //       controllerAs: 'editor'\n      //     }\n      //   },\n      //   resolve: {\n      //     stateMessage: stateNewMessage\n      //   }\n      // })\n      .state('mail.account.mailbox.message', {\n        url: '/:messageId',\n        views: {\n          message: {\n            templateUrl: 'UIxMailViewTemplate', // UI/Templates/MailerUI/UIxMailViewTemplate.wox\n            controller: 'MessageController',\n            controllerAs: 'viewer'\n          }\n        },\n        onEnter: onEnterMessage,\n        onExit: onExitMessage,\n        resolve: {\n          stateMessage: stateMessage\n        }\n      });\n      // .state('mail.account.mailbox.message.edit', {\n      //   url: '/edit',\n      //   views: {\n      //     'mailbox@mail': {\n      //       templateUrl: 'UIxMailEditor', // UI/Templates/MailerUI/UIxMailEditor.wox\n      //       controller: 'MessageEditorController',\n      //       controllerAs: 'editor'\n      //     }\n      //   },\n      //   resolve: {\n      //     stateContent: stateContent\n      //   }\n      // })\n      // .state('mail.account.mailbox.message.action', {\n      //   url: '/{actionName:(?:reply|replyall|forward)}',\n      //   views: {\n      //     'mailbox@mail': {\n      //       templateUrl: 'UIxMailEditor', // UI/Templates/MailerUI/UIxMailEditor.wox\n      //       controller: 'MessageEditorController',\n      //       controllerAs: 'editor'\n      //     }\n      //   }\n      // });\n\n    // if none of the above states are matched, use this as the fallback\n    $urlRouterProvider.otherwise('/Mail/0/inbox');\n  }\n\n  /**\n   * @ngInject\n   */\n  stateAccounts.$inject = ['$q', 'Account'];\n  function stateAccounts($q, Account) {\n    var accounts = Account.$findAll(window.mailAccounts),\n        promises = [];\n    // Fetch list of mailboxes for each account\n    angular.forEach(accounts, function(account, i) {\n      var mailboxes = account.$getMailboxes();\n      promises.push(mailboxes.then(function(objects) {\n        return account;\n      }));\n    });\n    return $q.all(promises);\n  }\n\n  /**\n   * @ngInject\n   */\n  stateAccount.$inject = ['$stateParams', 'stateAccounts'];\n  function stateAccount($stateParams, stateAccounts) {\n    return _.find(stateAccounts, function(account) {\n      return account.id == $stateParams.accountId;\n    });\n  }\n\n  /**\n   * @ngInject\n   */\n  stateMailbox.$inject = ['$q', '$state', '$stateParams', 'stateAccount', 'decodeUriFilter', 'Mailbox'];\n  function stateMailbox($q, $state, $stateParams, stateAccount, decodeUriFilter, Mailbox) {\n    var mailbox,\n        mailboxId = decodeUriFilter($stateParams.mailboxId),\n        _find;\n\n    // Recursive find function\n    _find = function(mailboxes) {\n      var mailbox = _.find(mailboxes, function(o) {\n        return o.path == mailboxId;\n      });\n      if (!mailbox) {\n        angular.forEach(mailboxes, function(o) {\n          if (!mailbox && o.children && o.children.length > 0) {\n            mailbox = _find(o.children);\n          }\n        });\n      }\n      return mailbox;\n    };\n\n    if (Mailbox.selectedFolder)\n      Mailbox.selectedFolder.$isLoading = true;\n\n    mailbox = _find(stateAccount.$mailboxes);\n\n    if (mailbox)\n      return mailbox;\n    else\n      // Mailbox not found\n      return $state.go('mail.account.inbox');\n  }\n\n  /**\n   * @ngInject\n   */\n  stateInbox.$inject = ['stateAccount', 'Mailbox'];\n  function stateInbox(stateAccount, Mailbox) {\n    if (Mailbox.selectedFolder)\n      Mailbox.selectedFolder.$isLoading = true;\n\n    return stateAccount.$mailboxes[0];\n  }\n\n  /**\n   * @ngInject\n   */\n  stateMessages.$inject = ['Mailbox', 'stateMailbox'];\n  function stateMessages(Mailbox, stateMailbox) {\n    if (Mailbox.$virtualMode)\n      return [];\n\n    return stateMailbox.$filter();\n  }\n\n  /**\n   * @ngInject\n   */\n  // stateNewMessage.$inject = ['stateAccount'];\n  // function stateNewMessage(stateAccount) {\n  //   return stateAccount.$newMessage();\n  // }\n\n  /**\n   * Return a VirtualMailbox instance\n   * @ngInject\n   */\n  stateVirtualMailbox.$inject = ['$q', 'Mailbox'];\n  function stateVirtualMailbox($q, Mailbox) {\n    if (Mailbox.$virtualMode)\n      return Mailbox.selectedFolder;\n    else\n      return $q.reject(\"No virtual mailbox defined\");\n  }\n\n  /**\n   * Return a Mailbox instance from a VirtualMailbox instance\n   * @ngInject\n   */\n  stateVirtualMailboxOfMessage.$inject = ['$q', 'Mailbox', 'decodeUriFilter', '$stateParams'];\n  function stateVirtualMailboxOfMessage($q, Mailbox, decodeUriFilter, $stateParams) {\n    var mailboxId = decodeUriFilter($stateParams.mailboxId);\n\n    if (Mailbox.$virtualMode) {\n      Mailbox.selectedFolder.resetSelectedMessage();\n      return _.find(Mailbox.selectedFolder.$mailboxes, function(mailboxObject) {\n        return mailboxObject.path == mailboxId;\n      });\n    }\n    else\n      return $q.reject(\"No virtual mailbox defined for message\");\n  }\n\n  /**\n   * @ngInject\n   */\n  stateMessage.$inject = ['Mailbox', 'encodeUriFilter', '$stateParams', '$state', 'stateMailbox', 'stateMessages'];\n  function stateMessage(Mailbox, encodeUriFilter, $stateParams, $state, stateMailbox, stateMessages) {\n    var message;\n\n    message = _.find(stateMailbox.$messages, function(messageObject) {\n      return messageObject.uid == parseInt($stateParams.messageId);\n    });\n\n    if (message) {\n      return message.$reload();\n    }\n    else {\n      // Message not found\n      $state.go('mail.account.mailbox', { accountId: stateMailbox.$account.id, mailboxId: encodeUriFilter(stateMailbox.path) });\n    }\n  }\n\n  /**\n   * @ngInject\n   */\n  onEnterMessage.$inject = ['$stateParams', 'stateMailbox'];\n  function onEnterMessage($stateParams, stateMailbox) {\n    stateMailbox.selectedMessage = parseInt($stateParams.messageId);\n  }\n\n  /**\n   * @ngInject\n   */\n  onExitMessage.$inject = ['stateMailbox'];\n  function onExitMessage(stateMailbox) {\n    stateMailbox.selectedMessage = -1;\n  }\n\n  /**\n   * @ngInject\n   */\n  // stateContent.$inject = ['stateMessage'];\n  // function stateContent(stateMessage) {\n  //   return stateMessage.$editableContent();\n  // }\n\n  /**\n   * @ngInject\n   */\n  runBlock.$inject = ['$rootScope', '$log', '$state'];\n  function runBlock($rootScope, $log, $state) {\n    $rootScope.$on('$stateChangeError', function(event, toState, toParams, fromState, fromParams, error) {\n      $log.error(error);\n      $state.go('mail');\n    });\n    $rootScope.$on('$routeChangeError', function(event, current, previous, rejection) {\n      $log.error(event, current, previous, rejection);\n    });\n  }\n\n})();\n"]}